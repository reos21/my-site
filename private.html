<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>

<!-- –®—Ä–∏—Ñ—Ç—ã -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f3f5f8; --card:#ffffff; --muted:#7b7b7b; --accent:#007bff; --accent-2:#28a745;
}
body.dark { --bg:#0f1115; --card:#16181b; --muted:#bdbdbd; --accent:#3399ff; --accent-2:#42b983; color:#eee; }
body{ font-family:Inter,system-ui,Arial; margin:0; height:100vh; background:var(--bg); color:inherit; display:flex; flex-direction:column; }

/* header */
header{ height:56px; display:flex; align-items:center; justify-content:space-between; padding:0 12px; background:var(--card); box-shadow:0 1px 0 rgba(0,0,0,0.04); }
.header-left{ display:flex; gap:8px; align-items:center; }
.icon-btn{ background:transparent; border:0; padding:8px; border-radius:8px; cursor:pointer; font-size:16px; }
.icon-btn:active{ transform:translateY(1px); }
#menuBtn { background:linear-gradient(90deg,var(--accent),#0056b3); color:#fff; }

.header-right{ display:flex; gap:8px; align-items:center; }

/* layout */
.container{ display:flex; flex:1; height:calc(100vh - 56px); overflow:hidden; position:relative; }

/* sidebar (menu) */
.sidebar{
  width:320px; max-width:80%; background:var(--card); border-right:1px solid rgba(0,0,0,0.06);
  display:flex; flex-direction:column; padding:12px; box-sizing:border-box;
}
.sidebar .title{ font-weight:600; margin-bottom:8px; }
.searchBox{ display:flex; gap:8px; margin-bottom:8px; }
.searchBox input{ flex:1; padding:8px 10px; border-radius:8px; border:1px solid #ddd; background:transparent; color:inherit; }
.smallBtn{ padding:8px 10px; border-radius:8px; border:0; cursor:pointer; background:var(--accent); color:#fff; }

/* chat list */
.chat-list{ overflow:auto; flex:1; padding-right:6px; }
.chat-item{ padding:10px; border-radius:10px; display:flex; align-items:center; justify-content:space-between; gap:10px; cursor:pointer; }
.chat-item .left{ display:flex; gap:8px; align-items:center; }
.chat-item .avatar{ width:36px; height:36px; border-radius:50%; background:linear-gradient(135deg,#eee,#ddd); display:flex; align-items:center; justify-content:center; font-weight:600; color:#333; }
.chat-item .meta{ display:flex; flex-direction:column; }
.chat-item .name{ font-weight:600; }
.chat-item .last{ font-size:13px; color:var(--muted); max-width:160px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.chat-item:hover{ background:rgba(0,0,0,0.03); }
.chat-item.active{ background:linear-gradient(90deg,var(--accent),#0056b3); color:#fff; }
.chat-unread{ background:#e53935; color:#fff; border-radius:999px; padding:4px 8px; font-size:12px; }

/* auth area in sidebar */
.auth { display:flex; flex-direction:column; gap:8px; margin-bottom:8px; }
.auth input{ padding:8px; border-radius:8px; border:1px solid #ddd; }
.auth .row{ display:flex; gap:8px; }

/* overlay menu for mobile */
.overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.45); opacity:0; pointer-events:none; transition:opacity .22s; }
.overlay.show{ opacity:1; pointer-events:auto; }

/* sliding sidebar for mobile */
.sidebar-panel{ position:fixed; left:-360px; top:56px; bottom:0; width:320px; z-index:60; transition:left .28s cubic-bezier(.2,.9,.3,1); box-shadow: 6px 0 24px rgba(0,0,0,0.12); }
.sidebar-panel.show{ left:0; }

/* chat window */
.chat-window{ flex:1; display:flex; flex-direction:column; min-width:0; }
.chat-header{ height:64px; display:flex; align-items:center; gap:12px; padding:12px; border-bottom:1px solid rgba(0,0,0,0.04); background:var(--card); }
.chat-header .title{ font-weight:600; }
.typing{ font-size:13px; color:var(--muted); margin-left:6px; }

/* messages area */
.messages{ flex:1; overflow:auto; padding:16px; display:flex; flex-direction:column; gap:8px; background:linear-gradient(180deg,transparent,rgba(0,0,0,0.02)); }
.date-sep{ text-align:center; color:var(--muted); font-size:13px; margin:12px 0; }

/* message bubble */
.msg { max-width:72%; padding:10px 12px; border-radius:12px; background:var(--card); box-shadow:0 1px 0 rgba(0,0,0,0.03); }
.msg.mine{ align-self:flex-end; background:linear-gradient(90deg,var(--accent),#0056b3); color:#fff; }
.msg .time{ display:block; font-size:11px; color:var(--muted); margin-top:6px; text-align:right; }
.msg .delete{ position:relative; margin-left:8px; cursor:pointer; color:#c33; font-size:12px; }

/* input area */
.composer{ display:flex; gap:8px; padding:12px; align-items:center; border-top:1px solid rgba(0,0,0,0.04); background:var(--card); }
.composer textarea{ flex:1; min-height:48px; max-height:160px; padding:8px 10px; border-radius:10px; border:1px solid #ddd; resize:none; font-size:15px; }
.composer .sendBtn{ background:var(--accent-2); color:#fff; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; }

/* footer controls */
.controls{ display:flex; gap:8px; align-items:center; }

/* responsive */
@media(max-width:900px){
  .sidebar{ display:none; }
  .sidebar-panel{ display:block; }
  .chat-window{ width:100%; }
}
@media(min-width:901px){
  .sidebar-panel{ display:none; }
  .overlay{ display:none; }
}
</style>
</head>
<body>

<header>
  <div class="header-left">
    <button id="menuBtn" class="icon-btn" title="–ú–µ–Ω—é ‚ò∞">‚ò∞</button>
    <div style="font-weight:600">–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div>
    <div id="menuNotif" style="display:inline-block;margin-left:6px;"></div>
  </div>

  <div class="header-right">
    <div id="userInfo">‚Äî</div>
    <button id="themeBtn" class="icon-btn" title="–¢–µ–º–∞">üåì</button>
    <button id="logoutBtn" class="icon-btn" title="–í—ã–π—Ç–∏">üîì</button>
  </div>
</header>

<div class="container">
  <!-- desktop sidebar -->
  <aside class="sidebar" id="desktopSidebar">
    <div class="title">–ß–∞—Ç—ã</div>

    <div class="auth">
      <input id="inpNick" placeholder="–ù–∏–∫" />
      <input id="inpPass" placeholder="–ü–∞—Ä–æ–ª—å" type="password" />
      <div class="row">
        <button id="btnRegister" class="smallBtn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        <button id="btnLogin" class="smallBtn" style="background:var(--accent);">–í—Ö–æ–¥</button>
      </div>
      <div style="display:flex; gap:8px; margin-top:6px;">
        <button id="btnNewChat" class="smallBtn" style="flex:1;">–ù–∞–π—Ç–∏</button>
        <button id="btnLogout" class="smallBtn" style="flex:1; background:#c0392b;">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <div style="margin-bottom:8px;">
      <div class="searchBox">
        <input id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." />
        <button id="searchBtn" class="smallBtn">OK</button>
      </div>
      <div id="searchResults" style="max-height:120px; overflow:auto;"></div>
    </div>

    <div class="chat-list" id="chatListDesktop"></div>
  </aside>

  <!-- mobile sidebar panel (slides in) -->
  <div class="sidebar-panel" id="mobilePanel" aria-hidden="true">
    <div style="padding:12px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div style="font-weight:600;">–ú–µ–Ω—é</div>
        <button id="closePanel" class="icon-btn">‚úï</button>
      </div>

      <div style="margin-top:10px;">
        <input id="m_searchInput" placeholder="–ü–æ–∏—Å–∫..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;" />
      </div>

      <div id="mobileSearchResults" style="margin-top:8px;"></div>
      <hr style="margin:12px 0;">
      <div id="chatListMobile" style="max-height:60vh; overflow:auto;"></div>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <!-- chat window -->
  <section class="chat-window" id="chatWindow">
    <div class="chat-header" id="chatHeader">
      <div class="title" id="chatTitle">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
      <div class="typing" id="typingIndicator" style="display:none">–ø–µ—á–∞—Ç–∞–µ—Ç...</div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="composer">
      <textarea id="privateMessage" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
      <div style="display:flex;flex-direction:column;gap:8px;">
        <button class="sendBtn" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </section>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script>
/* ============ CONFIG ============ */
const firebaseConfig = {
  apiKey: "AIzaSyA5meIzTc-zrp3mV2Xg7QQ8Vf_brx58T-g",
  authDomain: "reos21-f0203.firebaseapp.com",
  projectId: "reos21-f0203",
  storageBucket: "reos21-f0203.firebasestorage.app",
  messagingSenderId: "221186151213",
  appId: "1:221186151213:web:7e9f4a842298070d8ff9a4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ============ UI refs ============ */
const menuBtn = document.getElementById('menuBtn');
const overlay = document.getElementById('overlay');
const mobilePanel = document.getElementById('mobilePanel');
const closePanel = document.getElementById('closePanel');
const chatListDesktop = document.getElementById('chatListDesktop');
const chatListMobile = document.getElementById('chatListMobile');
const searchInput = document.getElementById('searchInput');
const m_searchInput = document.getElementById('m_searchInput');
const searchResults = document.getElementById('searchResults');
const mobileSearchResults = document.getElementById('mobileSearchResults');
const messagesDiv = document.getElementById('messages');
const chatTitle = document.getElementById('chatTitle');
const typingIndicator = document.getElementById('typingIndicator');
const userInfo = document.getElementById('userInfo');
const inpNick = document.getElementById('inpNick');
const inpPass = document.getElementById('inpPass');
const btnRegister = document.getElementById('btnRegister');
const btnLogin = document.getElementById('btnLogin');
const btnLogout = document.getElementById('btnLogout');
const btnNewChat = document.getElementById('btnNewChat');
const btnNewSearch = document.getElementById('searchBtn');
const sendBtn = document.getElementById('sendBtn');
const privateMessageInput = document.getElementById('privateMessage');
const themeBtn = document.getElementById('themeBtn');
const menuNotif = document.getElementById('menuNotif');
const userInfoDisplay = document.getElementById('userInfo');
const btnClosePanel = document.getElementById('closePanel');

/* ============ STATE ============ */
let currentUser = null;
let selectedUser = null;
let unreadCounts = {}; // { user: count }
let typingTimeout = null;
let localTypingTimer = null;

/* ============ THEME ============ */
if(localStorage.getItem('chat_theme') === 'dark') document.body.classList.add('dark');
themeBtn.addEventListener('click', () => {
  document.body.classList.toggle('dark');
  localStorage.setItem('chat_theme', document.body.classList.contains('dark') ? 'dark' : 'light');
});

/* ============ MENU (mobile) ============ */
menuBtn.addEventListener('click', openPanel);
closePanel.addEventListener('click', closePanelFn);
overlay.addEventListener('click', closePanelFn);

function openPanel(){
  mobilePanel.classList.add('show');
  mobilePanel.setAttribute('aria-hidden','false');
  overlay.classList.add('show');
  overlay.style.display='block';
  setTimeout(()=>overlay.classList.add('visible'),10);
}
function closePanelFn(){
  mobilePanel.classList.remove('show');
  mobilePanel.setAttribute('aria-hidden','true');
  overlay.classList.remove('show');
  overlay.style.display='none';
}

/* ============ AUTH (local, simple) ============ */
btnRegister.addEventListener('click', registerLocal);
btnLogin.addEventListener('click', loginLocal);
btnLogout.addEventListener('click', logoutLocal);
btnNewChat.addEventListener('click', ()=>{ if(!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ'); const q = prompt('–ù–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'); if(q) startChat(q.trim()); });
btnNewSearch.addEventListener('click', ()=>searchUsers(searchInput.value.trim(), searchResults, 'desktop'));

function registerLocal(){
  const nick = inpNick.value.trim();
  const pass = inpPass.value.trim();
  if(!nick || !pass) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∏ –ø–∞—Ä–æ–ª—å');
  const hash = CryptoJS.SHA256(pass).toString();
  db.collection('users').doc(nick).get().then(doc=>{
    if(doc.exists) return alert('–ù–∏–∫ –∑–∞–Ω—è—Ç');
    db.collection('users').doc(nick).set({passwordHash: hash});
    alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω. –í–æ–π–¥–∏—Ç–µ.');
  });
}

function loginLocal(){
  const nick = inpNick.value.trim();
  const pass = inpPass.value.trim();
  if(!nick || !pass) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∏ –ø–∞—Ä–æ–ª—å');
  const hash = CryptoJS.SHA256(pass).toString();
  db.collection('users').doc(nick).get().then(doc=>{
    if(!doc.exists) return alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
    if(doc.data().passwordHash !== hash) return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
    currentUser = nick;
    localStorage.setItem('chatUser', currentUser);
    userInfo.textContent = `–í—ã: ${currentUser}`;
    userInfoDisplay.textContent = currentUser;
    loadChats(); // start listening
    requestNotificationPerm();
    alert('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
  });
}

function logoutLocal(){
  localStorage.removeItem('chatUser');
  currentUser = null;
  userInfo.textContent = '';
  userInfoDisplay.textContent = '';
  chatListDesktop.innerHTML = '';
  chatListMobile.innerHTML = '';
  messagesDiv.innerHTML = '';
  alert('–í—ã –≤—ã—à–ª–∏');
}

/* autologin */
(function autoLogin(){
  const saved = localStorage.getItem('chatUser');
  if(saved){
    currentUser = saved;
    userInfo.textContent = `–í—ã: ${currentUser}`;
    userInfoDisplay.textContent = currentUser;
    loadChats();
    requestNotificationPerm();
  }
})();

/* ============ SEARCH USERS ============ */
function searchUsers(q, resultsContainer, mode){
  resultsContainer.innerHTML = '';
  if(!q) return;
  db.collection('users').get().then(snap=>{
    const found = [];
    snap.forEach(doc => {
      const uname = doc.id;
      if(uname.toLowerCase().includes(q.toLowerCase()) && uname !== currentUser) found.push(uname);
    });
    if(found.length===0){ resultsContainer.innerHTML = '<div style="padding:8px;color:var(--muted)">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }
    found.forEach(u=>{
      const item = document.createElement('div');
      item.className='chat-item';
      item.innerHTML = `<div style="display:flex;align-items:center;gap:10px"><div class="avatar">${u.charAt(0).toUpperCase()}</div><div><div class="name">${u}</div></div></div><div><button class="smallBtn">–ß–∞—Ç</button></div>`;
      item.querySelector('button').addEventListener('click', ()=> {
        startChat(u);
        if(mode==='desktop') searchInput.value=''; else m_searchInput.value='';
        resultsContainer.innerHTML='';
      });
      resultsContainer.appendChild(item);
    });
  });
}

/* mobile search wiring */
m_searchInput.addEventListener('input', ()=> searchUsers(m_searchInput.value.trim(), mobileSearchResults, 'mobile'));
searchInput.addEventListener('input', ()=> searchUsers(searchInput.value.trim(), searchResults, 'desktop'));

/* ============ CHAT LIST & UNREAD ============ */
let chatSnapshotUnsub = null;
function loadChats(){
  if(!currentUser) return;
  // realtime snapshot for all messages to compute chat list + unread counts
  if(chatSnapshotUnsub) chatSnapshotUnsub();
  chatSnapshotUnsub = db.collection('privateMessages').orderBy('timestamp','desc')
    .onSnapshot(snapshot=>{
      const lastByUser = {}; // last message per chat
      unreadCounts = {};
      snapshot.forEach(doc=>{
        const m = doc.data();
        if(m.from === currentUser || m.to === currentUser){
          const other = (m.from === currentUser) ? m.to : m.from;
          if(!lastByUser[other]) lastByUser[other] = {...m, id: doc.id};
          // unread count
          if(m.to === currentUser && !m.read) {
            unreadCounts[other] = (unreadCounts[other] || 0) + 1;
          }
        }
      });

      // render lists (desktop + mobile)
      renderChatList(lastByUser);
      // menu notif (if any unread anywhere)
      const totalUnread = Object.values(unreadCounts).reduce((a,b)=>a+(b||0),0);
      menuNotif.textContent = totalUnread>0 ? `üî¥ ${totalUnread}` : '';
    });
}

function renderChatList(lastByUser){
  // sort by timestamp desc
  const users = Object.keys(lastByUser).sort((a,b)=>{
    return (lastByUser[b].timestamp?.toDate()?.getTime()||0) - (lastByUser[a].timestamp?.toDate()?.getTime()||0);
  });

  chatListDesktop.innerHTML = '';
  chatListMobile.innerHTML = '';

  users.forEach(u=>{
    const last = lastByUser[u];
    const unread = unreadCounts[u] || 0;

    const el = document.createElement('div');
    el.className = 'chat-item' + (u===selectedUser ? ' active' : '');
    el.innerHTML = `<div style="display:flex;align-items:center;gap:10px"><div class="avatar">${u.charAt(0).toUpperCase()}</div>
      <div style="min-width:0"><div class="name">${u}</div><div class="last">${last.message || ''}</div></div></div>
      <div style="display:flex;flex-direction:column;align-items:flex-end"><div style="font-size:12px;color:var(--muted);">${last.timestamp ? formatShortTime(last.timestamp) : ''}</div>${unread?`<div class="chat-unread">${unread}</div>`:''}</div>`;

    el.addEventListener('click', ()=> {
      // set active
      selectedUser = u;
      document.querySelectorAll('.chat-item').forEach(node=>node.classList.remove('active'));
      el.classList.add('active');
      // close mobile panel if open
      closePanelFn();
      // open chat
      openChat(u);
    });

    const el2 = el.cloneNode(true);
    el2.addEventListener('click', ()=> { selectedUser = u; openChat(u); closePanelFn(); });

    chatListDesktop.appendChild(el);
    chatListMobile.appendChild(el2);
  });

  // when no chats
  if(users.length===0){
    chatListDesktop.innerHTML = '<div style="padding:12px;color:var(--muted)">–ù–µ—Ç —á–∞—Ç–æ–≤ ‚Äî –Ω–∞—á–Ω–∏—Ç–µ –ø–µ—Ä–µ–ø–∏—Å–∫—É —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫</div>';
    chatListMobile.innerHTML = chatListDesktop.innerHTML;
  }
}

/* ============ OPEN CHAT & MARK READ ============ */
let messagesUnsub = null;
function openChat(user){
  if(!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
  selectedUser = user;
  chatTitle.textContent = user;
  // clear messages area
  messagesDiv.innerHTML = '<div style="padding:12px;color:var(--muted)">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';

  // mark read
  markMessagesRead(user);

  // unsubscribe previous
  if(messagesUnsub) messagesUnsub();

  // subscribe to relevant messages (both directions) ordered
  messagesUnsub = db.collection('privateMessages')
    .where('pairKey','in', [pairKey(currentUser, user)]) // use pairKey trick to index by chat pair
    .orderBy('timestamp')
    .onSnapshot(snap => {
      // render
      messagesDiv.innerHTML = '';
      snap.forEach(doc => {
        const m = doc.data();
        const div = document.createElement('div');
        div.className = 'msg-wrapper';
        const bubble = document.createElement('div');
        bubble.className = 'msg' + (m.from === currentUser ? ' mine' : '');
        bubble.innerHTML = `${escapeHtml(m.message)}<div class="time">${formatTime(m.timestamp)}</div>`;
        // delete button for own messages
        if(m.from === currentUser){
          const del = document.createElement('span'); del.className='delete'; del.textContent='üóë';
          del.style.marginLeft='8px';
          del.addEventListener('click', ()=> {
            if(confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) db.collection('privateMessages').doc(doc.id).delete();
          });
          bubble.appendChild(del);
        }
        messagesDiv.appendChild(bubble);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

  // stop panel notif for this user
  unreadCounts[user] = 0;
  renderChatListFromCurrent(); // refresh UI counts
}

/* helper: re-render list using current DB-snapshot via loadChats() logic
   but simpler: trigger loadChats by re-calling loadChats() or re-render from DOM state.
   We'll just re-call loadChats to refresh. */
function renderChatListFromCurrent(){ /* no-op: list auto-updates from snapshot */ }

/* mark messages read (from `user` to currentUser) */
function markMessagesRead(user){
  db.collection('privateMessages')
    .where('from','==',user)
    .where('to','==',currentUser)
    .where('read','==',false)
    .get()
    .then(snap=> {
      const batch = db.batch();
      snap.forEach(doc=> batch.update(db.collection('privateMessages').doc(doc.id), { read: true }));
      if(snap.size>0) return batch.commit();
    }).catch(console.warn);
}

/* ============ PAIR KEY trick ============
Firestore cannot query "both from==A && to==B OR from==B && to==A" easily without composite indices.
We store and query a pairKey field: pairKey = `${min}_${max}` on each message for simple chat grouping.
*/
function pairKey(a,b){
  const arr = [a,b].slice().sort();
  return `${arr[0]}_${arr[1]}`;
}

/* send message (creates pairKey and read=false) */
sendBtn.addEventListener('click', sendPrivate);
privateMessageInput.addEventListener('keydown', (e)=> {
  if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendPrivate(); }
  startTyping(); // typing indicator
});

function sendPrivate(){
  if(!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ');
  if(!selectedUser) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞');
  const text = privateMessageInput.value.trim();
  if(!text) return;
  db.collection('privateMessages').add({
    from: currentUser,
    to: selectedUser,
    message: text,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    read: false,
    pairKey: pairKey(currentUser, selectedUser)
  });
  privateMessageInput.value = '';
  stopTyping();
}

/* ============ TYPING INDICATOR ============
We write a doc in typingStatus collection with id `${from}_${to}`, set typing:true/false.
Other side listens for documents where to==currentUser && typing==true
*/
let typingDocId = null;
function startTyping(){
  if(!currentUser || !selectedUser) return;
  const id = `${currentUser}_${selectedUser}`;
  typingDocId = id;
  db.collection('typingStatus').doc(id).set({ from: currentUser, to: selectedUser, typing: true, ts: firebase.firestore.FieldValue.serverTimestamp() });
  clearTimeout(localTypingTimer);
  localTypingTimer = setTimeout(()=> stopTyping(), 1500);
}
function stopTyping(){
  if(!typingDocId) return;
  db.collection('typingStatus').doc(typingDocId).set({ from: currentUser, to: selectedUser, typing: false, ts: firebase.firestore.FieldValue.serverTimestamp() });
  typingDocId = null;
  clearTimeout(localTypingTimer);
}

/* listen typing statuses for others typing to currentUser */
db.collection('typingStatus').where('to','==', currentUser || '__dummy__').onSnapshot(snap=>{
  let someoneTyping = false;
  snap.forEach(doc=>{
    const d = doc.data();
    if(d.to===currentUser && d.typing && d.from===selectedUser) someoneTyping = true;
  });
  typingIndicator.style.display = someoneTyping ? 'block' : 'none';
});

/* ============ NOTIFICATIONS for new incoming messages ============
Ask permission, then show notifications when doc added to privateMessages where to==currentUser and read==false
*/
function requestNotificationPerm(){
  if(!('Notification' in window)) return;
  if(Notification.permission === 'default') Notification.requestPermission();
}

db.collection('privateMessages').orderBy('timestamp','desc').onSnapshot(snap=>{
  snap.docChanges().forEach(change=>{
    if(change.type === 'added'){
      const m = change.doc.data();
      if(m.to === currentUser && !m.read){
        // desktop notification
        if(Notification.permission === 'granted'){
          new Notification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${m.from}`, { body: m.message, tag: `pm-${m.from}` });
        }
        // mark menu indicator
        updateMenuNotif();
      }
    }
  });
});

function updateMenuNotif(){
  // total unread
  const total = Object.values(unreadCounts).reduce((a,b)=>a+(b||0),0);
  menuNotif.textContent = total>0 ? `üî¥ ${total}` : '';
}

/* ============ Utilities ============ */
function formatTime(ts){
  if(!ts) return '';
  const d = ts.toDate ? ts.toDate() : new Date(ts);
  return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
}
function formatShortTime(ts){
  if(!ts) return '';
  const d = ts.toDate ? ts.toDate() : new Date(ts);
  return `${d.getDate()}.${(d.getMonth()+1).toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

/* ============ Start chat from search results (or new) ============ */
function startChat(username){
  if(!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ');
  if(username === currentUser) return alert('–ù–µ–ª—å–∑—è –ø–∏—Å–∞—Ç—å —Å–µ–±–µ');
  selectedUser = username;
  // show chat in UI and load
  closePanelFn();
  openChat(username);
}

/* Helper: subscribe to unread/last message snapshot logic performed in loadChats() above */

/* ensure Notification permission at load if logged in */
function initAfterLogin(){
  requestNotificationPerm();
  loadChats();
}

/* On first load, request auth if not logged in already (we used explicit auth controls, not modal) */
/* If logged in already, loadChats was called in autoLogin above */

/* Ensure mobile search input wires */
m_searchInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') searchUsers(m_searchInput.value.trim(), mobileSearchResults,'mobile'); });

/* Close mobile panel if window resized to desktop */
window.addEventListener('resize', ()=> { if(window.innerWidth>900){ overlay.classList.remove('show'); mobilePanel.classList.remove('show'); overlay.style.display='none'; }});

</script>
</body>
</html>