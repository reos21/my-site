<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg-color: #f9f9f9;
      --text-color: #222;
      --primary-color: #007bff;
      --secondary-color: #e7f3ff;
      --input-bg: #fff;
    }

    body.dark {
      --bg-color: #121212;
      --text-color: #eee;
      --primary-color: #3399ff;
      --secondary-color: #1e1e1e;
      --input-bg: #2a2a2a;
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      background: var(--primary-color);
      color: #fff;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header button {
      background: #fff;
      color: var(--primary-color);
      border: none;
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
    }

    main {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    #chats {
      width: 250px;
      border-right: 1px solid #ccc;
      background: var(--input-bg);
      overflow-y: auto;
    }

    #chatList {
      padding: 10px;
    }

    .chat-item {
      padding: 8px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
    }

    .chat-item:hover {
      background: var(--secondary-color);
    }

    .chat-item.active {
      background: var(--primary-color);
      color: #fff;
    }

    .chat-unread {
      background: red;
      color: white;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 12px;
    }

    #chatWindow {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    #messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
    }

    .message {
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 8px;
      background: var(--secondary-color);
      max-width: 80%;
    }

    .message.mine {
      background: var(--primary-color);
      color: white;
      align-self: flex-end;
    }

    .time {
      font-size: 11px;
      color: #aaa;
      display: block;
      text-align: right;
    }

    #sendBox {
      display: flex;
      padding: 10px;
      background: var(--input-bg);
    }

    #privateMessage {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
      background: var(--input-bg);
      color: var(--text-color);
    }

    #sendBtn {
      padding: 10px 15px;
      margin-left: 10px;
      background: var(--primary-color);
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    @media (max-width: 768px) {
      #chats { width: 40%; }
      #privateMessage { font-size: 18px; }
      #sendBtn { font-size: 18px; padding: 12px; }
      header { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>

<header>
  <div>
    <button onclick="goBack()">‚¨Ö –û–±—â–∏–π —á–∞—Ç</button>
    <button onclick="toggleTheme()">üåì –¢–µ–º–∞</button>
  </div>
  <div id="currentUserDisplay"></div>
</header>

<main>
  <div id="chats">
    <div id="chatList"></div>
  </div>

  <div id="chatWindow">
    <div id="messages"></div>
    <div id="sendBox">
      <input id="privateMessage" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
      <button id="sendBtn" onclick="sendPrivateMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</main>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyA5meIzTc-zrp3mV2Xg7QQ8Vf_brx58T-g",
    authDomain: "reos21-f0203.firebaseapp.com",
    projectId: "reos21-f0203",
    storageBucket: "reos21-f0203.firebasestorage.app",
    messagingSenderId: "221186151213",
    appId: "1:221186151213:web:7e9f4a842298070d8ff9a4",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let currentUser = null;
  let selectedUser = null;
  const chatListDiv = document.getElementById('chatList');
  const messagesDiv = document.getElementById('messages');

  // ====== –¢–ï–ú–ê ======
  if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark');
  function toggleTheme(){
    document.body.classList.toggle('dark');
    localStorage.setItem('theme', document.body.classList.contains('dark')?'dark':'light');
  }

  // ====== –í–•–û–î / –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ======
  async function authUser(){
    let stored = localStorage.getItem('chatUser');
    if(stored){
      currentUser = stored;
      document.getElementById('currentUserDisplay').textContent = `–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: ${currentUser}`;
      loadChats();
      return;
    }
    const username = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫:");
    const password = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å (–∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π):");
    if(!username || !password) return alert("–ù—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –Ω–∏–∫ –∏ –ø–∞—Ä–æ–ª—å!");
    const hash = CryptoJS.SHA256(password).toString();
    const ref = db.collection('users').doc(username);
    const docSnap = await ref.get();
    if(docSnap.exists){
      if(docSnap.data().passwordHash !== hash){
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
        return authUser();
      }
    } else {
      await ref.set({passwordHash: hash});
      alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω!");
    }
    currentUser = username;
    localStorage.setItem('chatUser', username);
    document.getElementById('currentUserDisplay').textContent = `–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: ${username}`;
    loadChats();
  }
  authUser();

  // ====== –ó–ê–ì–†–£–ó–ö–ê –°–ü–ò–°–ö–ê –ß–ê–¢–û–í ======
  function loadChats(){
    db.collection('privateMessages').orderBy('timestamp','desc').onSnapshot(snapshot=>{
      const chats={}, unread={};
      snapshot.forEach(doc=>{
        const msg = doc.data();
        if(msg.from===currentUser || msg.to===currentUser){
          const other = msg.from===currentUser?msg.to:msg.from;
          if(!chats[other]) chats[other]=msg;
          if(msg.to===currentUser && !msg.read) unread[other]=(unread[other]||0)+1;
        }
      });
      chatListDiv.innerHTML='';
      Object.keys(chats).forEach(user=>{
        const div=document.createElement('div');
        div.className='chat-item';
        if(user===selectedUser) div.classList.add('active');
        div.innerHTML=`<span>${user}</span>${unread[user]?`<span class='chat-unread'>${unread[user]}</span>`:''}`;
        div.onclick=()=>{selectedUser=user; loadMessages(); markRead(user);};
        chatListDiv.appendChild(div);
      });
    });
  }

  // ====== –ó–ê–ì–†–£–ó–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ======
  function loadMessages(){
    db.collection('privateMessages').orderBy('timestamp').onSnapshot(snapshot=>{
      messagesDiv.innerHTML='';
      snapshot.forEach(doc=>{
        const msg = doc.data();
        if((msg.from===currentUser && msg.to===selectedUser) || (msg.from===selectedUser && msg.to===currentUser)){
          const div=document.createElement('div');
          div.className='message'+(msg.from===currentUser?' mine':'');
          div.innerHTML=`${msg.message}<span class='time'>${formatTime(msg.timestamp)}</span>`;
          messagesDiv.appendChild(div);
        }
      });
      messagesDiv.scrollTop=messagesDiv.scrollHeight;
    });
  }

  function sendPrivateMessage(){
    const text=document.getElementById('privateMessage').value.trim();
    if(!text||!selectedUser) return;
    db.collection('privateMessages').add({
      from: currentUser, to: selectedUser, message: text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(), read: false
    });
    document.getElementById('privateMessage').value='';
  }

  function markRead(user){
    db.collection('privateMessages')
      .where('from','==',user).where('to','==',currentUser).where('read','==',false)
      .get().then(snap=>{
        snap.forEach(doc=>db.collection('privateMessages').doc(doc.id).update({read:true}));
      });
  }

  // ====== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ======
  if(Notification.permission!=="granted") Notification.requestPermission();
  db.collection('privateMessages').orderBy('timestamp','desc').onSnapshot(snapshot=>{
    snapshot.docChanges().forEach(change=>{
      if(change.type==='added'){
        const msg=change.doc.data();
        if(msg.to===currentUser && !msg.read && Notification.permission==="granted"){
          new Notification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${msg.from}`,{body:msg.message});
        }
      }
    });
  });

  function formatTime(ts){
    if(!ts) return '';
    const d=ts.toDate();
    return `${d.toLocaleDateString()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
  }

  function goBack(){
    window.location.href='index.html';
  }
</script>

</body>
</html>