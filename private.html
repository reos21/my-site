<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body, html {
    margin:0; padding:0; font-family:sans-serif;
    height:100%; overflow:hidden; background:#f5f7fa;
  }

  #container { display:flex; flex-direction:column; height:100vh; }

  #header {
    background:#007bff; color:white; padding:10px;
    text-align:center; font-weight:bold; position:relative;
  }

  #backBtn {
    position:absolute; left:10px; top:8px;
    background:white; color:#007bff; border:none;
    border-radius:5px; padding:6px 10px;
    cursor:pointer; font-weight:600;
  }

  #chatToggle {
    position:absolute; right:10px; top:8px;
    background:white; color:#007bff; border:none;
    border-radius:5px; padding:6px 10px;
    cursor:pointer; font-weight:600; z-index:10;
  }

  #main {
    flex:1; display:flex; overflow:hidden; height:100%;
    position:relative;
  }

  /* –ü–∞–Ω–µ–ª—å —á–∞—Ç–æ–≤ */
  #chatList {
    width:260px; background:#fff; border-right:1px solid #ddd;
    padding:10px; box-sizing:border-box; overflow-y:auto;
    transition:transform 0.3s ease;
  }

  /* –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
  @media (max-width: 768px) {
    #chatList {
      position:absolute; left:0; top:0; bottom:0;
      z-index:100; transform:translateX(-100%);
      box-shadow:2px 0 5px rgba(0,0,0,0.1);
    }
    #chatList.active { transform:translateX(0); }
  }

  #searchUser { width:100%; padding:8px; margin-bottom:8px; font-size:15px; box-sizing:border-box; }
  .chat-item {
    padding:10px; border-bottom:1px solid #eee;
    cursor:pointer; border-radius:5px;
  }
  .chat-item:hover { background:#f0f4ff; }
  .chat-item.active { background:#e3f0ff; font-weight:bold; }

  /* –ß–∞—Ç */
  #chatArea {
    flex:1; display:flex; flex-direction:column;
    background:#fdfdfd; position:relative;
  }
  #messages {
    flex:1; overflow-y:auto; padding:10px;
  }
  .msg { margin:5px 0; padding:8px 10px; border-radius:10px; max-width:75%; }
  .mine { background:#d8ecff; align-self:flex-end; }
  .theirs { background:#eee; align-self:flex-start; }
  .time { display:block; font-size:12px; color:#666; margin-top:3px; text-align:right; }

  #inputArea {
    display:flex; padding:10px; border-top:1px solid #ddd;
    background:#fff;
  }
  #messageInput {
    flex:1; padding:10px; font-size:16px;
    border:1px solid #ccc; border-radius:8px;
  }
  #sendBtn {
    margin-left:10px; padding:10px 14px;
    background:#007bff; color:white; border:none;
    border-radius:8px; cursor:pointer; font-weight:600;
  }

</style>
</head>
<body>

<div id="container">
  <div id="header">
    <button id="backBtn" onclick="window.location.href='index.html'">‚Üê –û–±—â–∏–π —á–∞—Ç</button>
    –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    <button id="chatToggle" onclick="toggleChatList()">–ß–∞—Ç—ã</button>
  </div>

  <div id="main">
    <div id="chatList">
      <input id="searchUser" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." oninput="searchUsers()" />
      <div id="chatUsers"></div>
    </div>

    <div id="chatArea">
      <div id="messages"><i>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</i></div>
      <div id="inputArea">
        <input id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." />
        <button id="sendBtn" onclick="sendMessage()">‚û§</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyA5meIzTc-zrp3mV2Xg7QQ8Vf_brx58T-g",
    authDomain: "reos21-f0203.firebaseapp.com",
    projectId: "reos21-f0203",
    storageBucket: "reos21-f0203.firebasestorage.app",
    messagingSenderId: "221186151213",
    appId: "1:221186151213:web:7e9f4a842298070d8ff9a4",
    measurementId: "G-61G91NP8DR"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let currentUser = localStorage.getItem("chatUser");
  try {
    if (currentUser) {
      const parsed = JSON.parse(currentUser);
      currentUser = parsed.uid || parsed.username || currentUser;
    }
  } catch(e){}

  const messagesDiv = document.getElementById("messages");
  const chatUsersDiv = document.getElementById("chatUsers");
  const messageInput = document.getElementById("messageInput");
  let selectedUser = null;
  let unsubscribe = null;

  function toggleChatList() {
    const list = document.getElementById('chatList');
    list.classList.toggle('active');
  }

  // üì• –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  function searchUsers(){
    const q = document.getElementById('searchUser').value.toLowerCase();
    chatUsersDiv.innerHTML = '<i>–ó–∞–≥—Ä—É–∑–∫–∞...</i>';
    db.collection('users').get().then(snap=>{
      chatUsersDiv.innerHTML = '';
      snap.forEach(doc=>{
        const uname = doc.id;
        if(uname !== currentUser && uname.toLowerCase().includes(q)){
          const div = document.createElement('div');
          div.className = 'chat-item';
          div.textContent = uname;
          div.onclick = ()=>selectChat(uname);
          chatUsersDiv.appendChild(div);
        }
      });
    });
  }

  function selectChat(user){
    selectedUser = user;
    document.getElementById('chatList').classList.remove('active');
    loadMessages();
  }

  function formatTime(ts){
    if(!ts) return '';
    const d = ts.toDate();
    return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
  }

  // üì© –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
  function loadMessages(){
    if(unsubscribe) unsubscribe();
    if(!currentUser || !selectedUser){
      messagesDiv.innerHTML = '<i>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</i>';
      return;
    }
    messagesDiv.innerHTML = '<i>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</i>';
    unsubscribe = db.collection('privateMessages')
      .where('participants','array-contains', currentUser)
      .orderBy('timestamp')
      .onSnapshot(snap=>{
        messagesDiv.innerHTML = '';
        snap.forEach(doc=>{
          const msg = doc.data();
          if(!msg.timestamp) return;
          if(!msg.participants.includes(selectedUser)) return;
          const div = document.createElement('div');
          div.className = 'msg ' + (msg.from===currentUser?'mine':'theirs');
          div.innerHTML = `${msg.message}<span class="time">${formatTime(msg.timestamp)}</span>`;
          messagesDiv.appendChild(div);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }, err=>{
        messagesDiv.innerHTML = `<span style="color:red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</span>`;
        console.error(err);
      });
  }

  // ‚úâÔ∏è –û—Ç–ø—Ä–∞–≤–∫–∞
  function sendMessage(){
    const text = messageInput.value.trim();
    if(!text || !selectedUser) return;
    db.collection('privateMessages').add({
      from: currentUser,
      to: selectedUser,
      participants: [currentUser, selectedUser],
      message: text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    messageInput.value = '';
  }

  searchUsers();
</script>
</body>
</html>