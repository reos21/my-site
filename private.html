<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Личные сообщения</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body, html { margin:0; padding:0; font-family:sans-serif; height:100%; overflow:hidden; background:#fafafa;}
  #container { display:flex; flex-direction:column; height:100%; }
  #header { background:#007bff; color:#fff; padding:10px; text-align:center; position:relative; }
  #backBtn { position:absolute; left:10px; top:10px; background:#fff; color:#007bff; border:none; padding:5px 10px; cursor:pointer; border-radius:4px; }
  #main { flex:1; display:flex; overflow:hidden; }
  #chatList { width:200px; border-right:1px solid #ccc; background:#fff; overflow-y:auto; display:flex; flex-direction:column; transition: transform 0.3s ease; }
  #chatList.hidden { transform: translateX(-100%); }
  #chatList input { margin:5px; padding:5px; }
  .user-item { padding:8px; border-bottom:1px solid #eee; cursor:pointer; }
  .user-item:hover { background:#f0f0f0; }
  #chatContent { flex:1; display:flex; flex-direction:column; height:100%; }
  #messages { flex:1; overflow-y:auto; padding:10px; background:#fff; }
  .message { margin-bottom:5px; padding:5px 8px; border-radius:5px; border-bottom:1px solid #eee; }
  .my-message { background:#e7f3ff; }
  .time { font-size:12px; color:#888; margin-left:5px; }
  #inputArea { display:flex; padding:5px; background:#fff; border-top:1px solid #ccc; }
  #privateMessage { flex:1; padding:8px; font-size:14px; }
  #sendBtn { padding:8px 12px; margin-left:5px; background:#007bff; color:#fff; border:none; cursor:pointer; border-radius:4px; }
  #toggleList { display:none; position:absolute; left:10px; bottom:10px; background:#007bff; color:#fff; border:none; padding:5px 10px; border-radius:4px; z-index:10; }
  @media(max-width:700px){
    #chatList { position:absolute; top:0; left:0; height:100%; z-index:5; background:#fff; transform:translateX(-100%);}
    #toggleList { display:block; }
  }
</style>
</head>
<body>
<div id="container">
  <div id="header">
    <button id="backBtn" onclick="goToCommonChat()">⬅ Общий чат</button>
    Личные сообщения
    <button id="toggleList" onclick="toggleChatList()">Чаты</button>
  </div>
  <div id="main">
    <div id="chatList">
      <input id="searchUser" placeholder="Поиск пользователя" oninput="searchUsers()">
      <div id="userList"></div>
    </div>
    <div id="chatContent">
      <div id="messages">Выберите чат</div>
      <div id="inputArea">
        <input id="privateMessage" placeholder="Введите сообщение">
        <button id="sendBtn" onclick="sendPrivateMessage()">Отправить</button>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyA5meIzTc-zrp3mV2Xg7QQ8Vf_brx58T-g",
    authDomain: "reos21-f0203.firebaseapp.com",
    projectId: "reos21-f0203",
    storageBucket: "reos21-f0203.firebasestorage.app",
    messagingSenderId: "221186151213",
    appId: "1:221186151213:web:7e9f4a842298070d8ff9a4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let currentUser = null;
let selectedUser = null;
let messagesUnsub = null;

// ==== Вход и регистрация (локальные данные) ====
function loginUser(username){
  if(!username) return;
  currentUser = username;
  localStorage.setItem('chatUser', currentUser);
  loadChats();
}

// ==== Загрузка списка чатов ====
function loadChats(){
  db.collection('privateMessages').get().then(snap=>{
    const users = new Set();
    snap.forEach(doc=>{
      const msg = doc.data();
      if(msg.from===currentUser) users.add(msg.to);
      if(msg.to===currentUser) users.add(msg.from);
    });
    renderUserList([...users]);
  });
}

function renderUserList(users){
  const ul = document.getElementById('userList');
  ul.innerHTML='';
  users.forEach(u=>{
    const div = document.createElement('div');
    div.textContent=u;
    div.className='user-item';
    div.onclick=()=>{ selectUser(u); };
    ul.appendChild(div);
  });
}

// ==== Поиск пользователей ====
function searchUsers(){
  const q = document.getElementById('searchUser').value.trim().toLowerCase();
  db.collection('users').get().then(snap=>{
    const ul = document.getElementById('userList');
    ul.innerHTML='';
    snap.forEach(doc=>{
      const uname = doc.id;
      if(uname.toLowerCase().includes(q) && uname!==currentUser){
        const div = document.createElement('div');
        div.textContent=uname;
        div.className='user-item';
        div.onclick=()=>{ selectUser(uname); };
        ul.appendChild(div);
      }
    });
  });
}

// ==== Выбор пользователя ====
function selectUser(user){
  selectedUser = user;
  document.getElementById('messages').innerHTML='Загрузка...';
  if(messagesUnsub) messagesUnsub();
  loadPrivateMessages();
  if(window.innerWidth<700) document.getElementById('chatList').classList.add('hidden');
}

// ==== Загрузка сообщений ====
function pairKey(u1,u2){ return [u1,u2].sort().join('_'); }
function formatTime(ts){ const d=ts.toDate(); return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0'); }

function loadPrivateMessages(){
  if(!currentUser || !selectedUser) return;
  const pk = pairKey(currentUser, selectedUser);
  messagesUnsub = db.collection('privateMessages')
    .orderBy('timestamp')
    .onSnapshot(snap=>{
      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML='';
      snap.forEach(doc=>{
        const msg = doc.data();
        if(!msg.timestamp) return;
        if(msg.pairKey!==pk && !(msg.from===currentUser && msg.to===selectedUser) && !(msg.from===selectedUser && msg.to===currentUser)) return;
        const isMine = msg.from===currentUser;
        messagesDiv.innerHTML+=`<div class="message ${isMine?'my-message':''}"><b>${isMine?'Вы':msg.from}</b>: ${msg.message} <span class="time">(${formatTime(msg.timestamp)})</span></div>`;
      });
      messagesDiv.scrollTop=messagesDiv.scrollHeight;
    });
}

// ==== Отправка сообщений ====
function sendPrivateMessage(){
  if(!currentUser || !selectedUser) return alert('Выберите чат');
  const msg = document.getElementById('privateMessage').value.trim();
  if(!msg) return;
  const pk = pairKey(currentUser, selectedUser);
  db.collection('privateMessages').add({
    from: currentUser,
    to: selectedUser,
    message: msg,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    pairKey: pk,
    read: false
  });
  document.getElementById('privateMessage').value='';
}

// ==== Плавное скрытие/показ списка чатов на телефоне ====
function toggleChatList(){
  const list = document.getElementById('chatList');
  list.classList.toggle('hidden');
}

// ==== Кнопка назад в общий чат ====
function goToCommonChat(){
  window.location.href='index.html';
}

// ==== Инициализация текущего пользователя ====
window.onload=function(){
  let u = localStorage.getItem('chatUser');
  if(u) loginUser(u);
}
</script>
</body>
</html>