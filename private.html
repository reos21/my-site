<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Личные сообщения</title>
<style>
  * { box-sizing: border-box; }
  html, body {
    margin: 0; padding: 0;
    height: 100%;
    font-family: sans-serif;
    background: #f5f7fa;
  }

  /* HEADER */
  #header {
    background: #007bff;
    color: #fff;
    padding: 10px;
    text-align: center;
    position: relative;
    font-weight: bold;
  }
  #backBtn, #chatToggle {
    position: absolute;
    top: 8px;
    background: #fff;
    color: #007bff;
    border: none;
    border-radius: 5px;
    padding: 6px 10px;
    cursor: pointer;
    font-weight: 600;
  }
  #backBtn { left: 10px; }
  #chatToggle { right: 10px; }

  /* MAIN */
  #main {
    display: flex;
    height: calc(100vh - 50px);
    overflow: hidden;
  }

  /* Список чатов */
  #chatList {
    width: 260px;
    background: #fff;
    border-right: 1px solid #ddd;
    padding: 10px;
    overflow-y: auto;
    transition: transform 0.3s ease;
  }
  #searchUser {
    width: 100%;
    padding: 8px;
    margin-bottom: 10px;
    font-size: 15px;
  }
  .chat-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    border-radius: 5px;
  }
  .chat-item:hover { background: #f0f4ff; }
  .chat-item.active { background: #e3f0ff; font-weight: bold; }

  /* Окно чата */
  #chatArea {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #fdfdfd;
    height: 100%;
  }

  #messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    display: flex;
    flex-direction: column;
  }

  .msg {
    margin: 6px 0;
    padding: 8px 10px;
    border-radius: 10px;
    max-width: 75%;
    word-wrap: break-word;
  }
  .mine { background: #d8ecff; align-self: flex-end; }
  .theirs { background: #eee; align-self: flex-start; }
  .time {
    font-size: 12px;
    color: #666;
    margin-top: 3px;
    text-align: right;
  }

  /* Поле ввода */
  #inputArea {
    display: flex;
    align-items: center;
    padding: 10px;
    border-top: 1px solid #ddd;
    background: #fff;
  }
  #messageInput {
    flex: 1;
    padding: 10px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 8px;
  }
  #sendBtn {
    margin-left: 10px;
    padding: 10px 14px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
  }

  /* Для телефона */
  @media (max-width: 768px) {
    #chatList {
      position: absolute;
      top: 0; left: 0; bottom: 0;
      z-index: 100;
      width: 80%;
      transform: translateX(-100%);
      box-shadow: 2px 0 5px rgba(0,0,0,0.2);
      background: #fff;
    }
    #chatList.active { transform: translateX(0); }
  }
</style>
</head>
<body>

<div id="header">
  <button id="backBtn" onclick="window.location.href='index.html'">← Общий чат</button>
  Личные сообщения
  <button id="chatToggle" onclick="toggleChatList()">Чаты</button>
</div>

<div id="main">
  <div id="chatList">
    <input id="searchUser" placeholder="Поиск пользователей..." oninput="searchUsers()">
    <div id="chatUsers"></div>
  </div>

  <div id="chatArea">
    <div id="messages"><i>Выберите чат</i></div>
    <div id="inputArea">
      <input id="messageInput" placeholder="Введите сообщение..." />
      <button id="sendBtn" onclick="sendMessage()">➤</button>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyA5meIzTc-zrp3mV2Xg7QQ8Vf_brx58T-g",
    authDomain: "reos21-f0203.firebaseapp.com",
    projectId: "reos21-f0203",
    storageBucket: "reos21-f0203.firebasestorage.app",
    messagingSenderId: "221186151213",
    appId: "1:221186151213:web:7e9f4a842298070d8ff9a4",
    measurementId: "G-61G91NP8DR"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // === Пользователь ===
  let currentUser = localStorage.getItem("chatUser");
  try {
    const parsed = JSON.parse(currentUser);
    currentUser = parsed.username || parsed.uid || "Гость";
  } catch { currentUser = "Гость"; }

  const messagesDiv = document.getElementById("messages");
  const chatUsersDiv = document.getElementById("chatUsers");
  const messageInput = document.getElementById("messageInput");
  let selectedUser = null;
  let unsubscribe = null;

  function toggleChatList() {
    document.getElementById("chatList").classList.toggle("active");
  }

  // === Поиск пользователей ===
  function searchUsers() {
    const q = document.getElementById("searchUser").value.toLowerCase();
    chatUsersDiv.innerHTML = "<i>Загрузка...</i>";
    db.collection("users").get().then(snap => {
      chatUsersDiv.innerHTML = "";
      snap.forEach(doc => {
        const uname = doc.id;
        if (uname !== currentUser && uname.toLowerCase().includes(q)) {
          const div = document.createElement("div");
          div.className = "chat-item";
          div.textContent = uname;
          div.onclick = () => selectChat(uname);
          chatUsersDiv.appendChild(div);
        }
      });
    });
  }

  function selectChat(user) {
    selectedUser = user;
    document.getElementById("chatList").classList.remove("active");
    loadMessages();
  }

  function formatTime(ts) {
    if (!ts) return "";
    const d = ts.toDate();
    return `${d.getHours().toString().padStart(2,"0")}:${d.getMinutes().toString().padStart(2,"0")}`;
  }

  // === Загрузка сообщений ===
  function loadMessages() {
    if (unsubscribe) unsubscribe();
    if (!selectedUser) {
      messagesDiv.innerHTML = "<i>Выберите чат</i>";
      return;
    }

    messagesDiv.innerHTML = "<i>Загрузка сообщений...</i>";
    unsubscribe = db.collection("privateMessages")
      .orderBy("timestamp")
      .onSnapshot(snapshot => {
        messagesDiv.innerHTML = "";
        snapshot.forEach(doc => {
          const msg = doc.data();
          if ((msg.from === currentUser && msg.to === selectedUser) ||
              (msg.from === selectedUser && msg.to === currentUser)) {
            const div = document.createElement("div");
            div.className = "msg " + (msg.from === currentUser ? "mine" : "theirs");
            div.innerHTML = `${msg.message}<div class='time'>${formatTime(msg.timestamp)}</div>`;
            messagesDiv.appendChild(div);
          }
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }, err => {
        console.error(err);
        messagesDiv.innerHTML = "<span style='color:red'>Ошибка загрузки сообщений</span>";
      });
  }

  // === Отправка ===
  function sendMessage() {
    const text = messageInput.value.trim();
    if (!text || !selectedUser) return;

    db.collection("privateMessages").add({
      from: currentUser,
      to: selectedUser,
      message: text,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    messageInput.value = "";
  }

  searchUsers();
</script>
</body>
</html>