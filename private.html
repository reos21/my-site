<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f3f5f8; --card:#fff; --muted:#6e6e6e; --accent:#007bff; --accent2:#28a745;
  }
  body.dark { --bg:#0f1115; --card:#161819; --muted:#bdbdbd; --accent:#3399ff; --accent2:#42b983; color:#eee; }
  body{ margin:0; font-family:Inter,system-ui,Arial; background:var(--bg); height:100vh; display:flex; flex-direction:column; color:inherit; }

  /* header */
  header{ height:56px; background:var(--card); display:flex; align-items:center; justify-content:space-between; padding:0 12px; box-shadow:0 1px 0 rgba(0,0,0,0.04); }
  .header-left{ display:flex; gap:8px; align-items:center; }
  .btn{ background:transparent; border:0; padding:8px; border-radius:8px; cursor:pointer; font-size:16px; }
  .primary{ background:linear-gradient(90deg,var(--accent),#0056b3); color:#fff; border:0; padding:8px 10px; border-radius:8px; }
  .small{ padding:6px 8px; border-radius:6px; border:0; background:var(--accent); color:#fff; }
  .muted{ color:var(--muted); font-size:14px; }

  /* layout */
  .container{ display:flex; flex:1; min-height:0; } /* min-height:0 to allow children scroll */
  /* desktop sidebar */
  .sidebar{ width:300px; background:var(--card); border-right:1px solid rgba(0,0,0,0.06); display:flex; flex-direction:column; padding:12px; box-sizing:border-box; }
  .sidebar .title{ font-weight:600; margin-bottom:8px; }
  .auth{ display:flex; flex-direction:column; gap:8px; margin-bottom:8px; }
  .auth input{ padding:8px; border-radius:8px; border:1px solid #ddd; background:transparent; color:inherit; }
  .auth .row{ display:flex; gap:8px; }
  .search{ display:flex; gap:8px; margin-bottom:10px; }
  .search input{ flex:1; padding:8px; border-radius:8px; border:1px solid #ddd; }
  .searchResults{ max-height:120px; overflow:auto; margin-bottom:8px; }

  .chat-list{ overflow:auto; flex:1; }
  .chat-item{ padding:8px; border-radius:8px; display:flex; justify-content:space-between; gap:8px; cursor:pointer; align-items:center; }
  .chat-item .left{ display:flex; gap:8px; align-items:center; min-width:0; }
  .avatar{ width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:600; background:linear-gradient(135deg,#eee,#ddd); color:#333; }
  .chat-item .meta{ overflow:hidden; }
  .chat-item .name{ font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:160px; }
  .chat-item .last{ color:var(--muted); font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:160px; }
  .chat-item:hover{ background:rgba(0,0,0,0.03); }
  .chat-item.active{ background:linear-gradient(90deg,var(--accent),#0056b3); color:#fff; }
  .unread{ background:#e53935; color:#fff; padding:4px 8px; border-radius:999px; font-size:12px; }

  /* mobile panel */
  .overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.45); opacity:0; pointer-events:none; transition:opacity .22s; }
  .overlay.show{ opacity:1; pointer-events:auto; }
  .panel{ position:fixed; top:56px; left:-360px; bottom:0; width:320px; background:var(--card); box-shadow:6px 0 30px rgba(0,0,0,0.12); z-index:60; transition:left .28s cubic-bezier(.2,.9,.3,1); overflow:auto; }
  .panel.show{ left:0; }

  /* chat window */
  .chat-window{ flex:1; display:flex; flex-direction:column; min-width:0; }
  .chat-header{ height:64px; display:flex; align-items:center; gap:12px; padding:12px; border-bottom:1px solid rgba(0,0,0,0.04); background:var(--card); }
  .chat-header .title{ font-weight:600; }
  .typing{ font-size:13px; color:var(--muted); margin-left:6px; }

  .messages{ flex:1; overflow:auto; padding:16px; display:flex; flex-direction:column; gap:8px; background:linear-gradient(180deg,transparent,rgba(0,0,0,0.02)); min-height:0; }
  .date-sep{ text-align:center; color:var(--muted); font-size:13px; margin:12px 0; }

  .msg{ max-width:72%; padding:10px 12px; border-radius:12px; background:var(--card); box-shadow:0 1px 0 rgba(0,0,0,0.03); align-self:flex-start; }
  .msg.mine{ align-self:flex-end; background:linear-gradient(90deg,var(--accent),#0056b3); color:#fff; }
  .msg .time{ display:block; font-size:11px; color:var(--muted); margin-top:6px; text-align:right; }
  .msg .del{ color:#c33; cursor:pointer; margin-left:8px; font-size:12px; }

  .composer{ display:flex; gap:8px; padding:12px; border-top:1px solid rgba(0,0,0,0.04); background:var(--card); align-items:center; }
  .composer textarea{ flex:1; min-height:48px; max-height:160px; padding:10px; border-radius:10px; border:1px solid #ddd; resize:none; font-size:15px; }
  .sendBtn{ background:var(--accent2); color:#fff; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; }

  /* smaller screens */
  @media (max-width:900px){
    .sidebar{ display:none; }
    .panel{ display:block; }
    .overlay{ display:block; }
    .chat-header{ padding-right:12px; }
    .messages{ padding:10px; }
  }
  @media (min-width:901px){
    .panel, .overlay{ display:none; }
  }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="header-left">
    <button id="menuBtn" class="primary btn">‚ò∞ –ß–∞—Ç—ã</button>
    <div style="font-weight:600">–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div>
    <div id="menuBadge" style="margin-left:8px;"></div>
  </div>

  <div class="header-right">
    <div id="userInfo" class="muted">–Ω–µ –≤ —Å–∏—Å—Ç–µ–º–µ</div>
    <button id="themeBtn" class="btn" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåì</button>
  </div>
</header>

<!-- MAIN -->
<div class="container">

  <!-- Desktop sidebar -->
  <aside class="sidebar" id="desktopSidebar">
    <div class="title">–ß–∞—Ç—ã</div>

    <div class="auth">
      <input id="inpNick" placeholder="–ù–∏–∫ (–ª–æ–≥–∏–Ω)" />
      <input id="inpPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å" />
      <div class="row" style="display:flex;gap:8px;">
        <button id="btnRegister" class="small">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        <button id="btnLogin" class="small" style="background:var(--accent)">–í—Ö–æ–¥</button>
      </div>
      <div style="display:flex; gap:8px;">
        <button id="btnNewChat" class="small" style="flex:1;">–ù–∞–π—Ç–∏</button>
        <button id="btnLogout" class="small" style="flex:1; background:#c0392b;">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <div class="search">
      <input id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." />
      <button id="searchBtn" class="small">OK</button>
    </div>
    <div id="searchResults" class="searchResults"></div>

    <div class="chat-list" id="chatListDesktop"></div>
  </aside>

  <!-- Mobile sliding panel -->
  <div class="panel" id="mobilePanel" aria-hidden="true">
    <div style="padding:12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div style="font-weight:600">–ú–µ–Ω—é</div>
        <button id="closePanel" class="btn">‚úï</button>
      </div>

      <div style="margin-top:10px;">
        <input id="m_searchInput" placeholder="–ü–æ–∏—Å–∫..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;" />
      </div>
      <div id="mobileSearchResults" style="margin-top:8px;"></div>

      <hr style="margin:12px 0;">
      <div id="chatListMobile" style="max-height:60vh; overflow:auto;"></div>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <!-- Chat window -->
  <section class="chat-window">
    <div class="chat-header">
      <div style="display:flex;flex-direction:column;">
        <div id="chatTitle" class="title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
        <div id="typingIndicator" class="typing" style="display:none">–ø–µ—á–∞—Ç–∞–µ—Ç...</div>
      </div>
      <div style="margin-left:auto"></div>
    </div>

    <div class="messages" id="messages">
      <div style="padding:12px;color:var(--muted)">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ‚ò∞</div>
    </div>

    <div class="composer">
      <textarea id="privateMessage" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." disabled></textarea>
      <button id="sendBtn" class="sendBtn" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </section>
</div>

<!-- Firebase + Crypto -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script>
/* ---------------- CONFIG ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyA5meIzTc-zrp3mV2Xg7QQ8Vf_brx58T-g",
  authDomain: "reos21-f0203.firebaseapp.com",
  projectId: "reos21-f0203",
  storageBucket: "reos21-f0203.firebasestorage.app",
  messagingSenderId: "221186151213",
  appId: "1:221186151213:web:7e9f4a842298070d8ff9a4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ---------------- UI refs ---------------- */
const menuBtn = document.getElementById('menuBtn');
const mobilePanel = document.getElementById('mobilePanel');
const overlay = document.getElementById('overlay');
const closePanelBtn = document.getElementById('closePanel');
const chatListDesktop = document.getElementById('chatListDesktop');
const chatListMobile = document.getElementById('chatListMobile');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const searchResults = document.getElementById('searchResults');
const m_searchInput = document.getElementById('m_searchInput');
const mobileSearchResults = document.getElementById('mobileSearchResults');
const messagesDiv = document.getElementById('messages');
const chatTitle = document.getElementById('chatTitle');
const typingIndicator = document.getElementById('typingIndicator');
const userInfo = document.getElementById('userInfo');
const inpNick = document.getElementById('inpNick');
const inpPass = document.getElementById('inpPass');
const btnRegister = document.getElementById('btnRegister');
const btnLogin = document.getElementById('btnLogin');
const btnLogout = document.getElementById('btnLogout');
const btnNewChat = document.getElementById('btnNewChat');
const btnSearch = document.getElementById('searchBtn');
const sendBtn = document.getElementById('sendBtn');
const privateMessageInput = document.getElementById('privateMessage');
const themeBtn = document.getElementById('themeBtn');
const menuBadge = document.getElementById('menuBadge');

/* ---------------- STATE ---------------- */
let currentUser = null;        // string username
let selectedUser = null;       // string username
let unreadCounts = {};        // {user: count}
let chatsSnapshotUnsub = null;
let messagesUnsub = null;
let typingDocId = null;
let localTypingTimer = null;

/* ---------------- THEME ---------------- */
if(localStorage.getItem('chat_theme') === 'dark') document.body.classList.add('dark');
themeBtn.addEventListener('click', ()=>{
  document.body.classList.toggle('dark');
  localStorage.setItem('chat_theme', document.body.classList.contains('dark') ? 'dark' : 'light');
});

/* ---------------- MOBILE PANEL ---------------- */
menuBtn.addEventListener('click', ()=>{ mobilePanel.classList.add('show'); overlay.classList.add('show'); overlay.style.display='block'; });
closePanelBtn.addEventListener('click', ()=>{ mobilePanel.classList.remove('show'); overlay.classList.remove('show'); overlay.style.display='none'; });
overlay.addEventListener('click', ()=>{ mobilePanel.classList.remove('show'); overlay.classList.remove('show'); overlay.style.display='none'; });

/* ---------------- AUTH ---------------- */
btnRegister.addEventListener('click', registerLocal);
btnLogin.addEventListener('click', loginLocal);
btnLogout.addEventListener('click', logoutLocal);
btnNewChat.addEventListener('click', ()=>{ if(!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ'); const q = prompt('–ù–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'); if(q) startChat(q.trim()); });
searchBtn.addEventListener('click', ()=> searchUsers(searchInput.value.trim(), searchResults, 'desktop'));

/* login/register functions (local, hash stored) */
function registerLocal(){
  const nick = inpNick.value.trim();
  const pass = inpPass.value.trim();
  if(!nick || !pass) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∏ –ø–∞—Ä–æ–ª—å');
  const hash = CryptoJS.SHA256(pass).toString();
  db.collection('users').doc(nick).get().then(doc=>{
    if(doc.exists) return alert('–ù–∏–∫ –∑–∞–Ω—è—Ç');
    db.collection('users').doc(nick).set({ passwordHash: hash }).then(()=> alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞ ‚Äî —Ç–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ'));
  }).catch(err=>console.error(err));
}

function loginLocal(){
  const nick = inpNick.value.trim();
  const pass = inpPass.value.trim();
  if(!nick || !pass) return alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∏ –ø–∞—Ä–æ–ª—å');
  const hash = CryptoJS.SHA256(pass).toString();
  db.collection('users').doc(nick).get().then(doc=>{
    if(!doc.exists) return alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
    if(doc.data().passwordHash !== hash) return alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
    // set current user as plain string
    currentUser = nick;
    localStorage.setItem('chatUser', currentUser);
    userInfo.textContent = `–í—ã: ${currentUser}`;
    userInfo.style.color = '';
    requestNotificationPerm();
    startAppAfterLogin();
  }).catch(err=>console.error(err));
}

function logoutLocal(){
  if(!currentUser) return;
  localStorage.removeItem('chatUser');
  currentUser = null;
  selectedUser = null;
  if(chatsSnapshotUnsub) chatsSnapshotUnsub();
  if(messagesUnsub) messagesUnsub();
  chatListDesktop.innerHTML = '';
  chatListMobile.innerHTML = '';
  messagesDiv.innerHTML = '<div style="padding:12px;color:var(--muted)">–í—ã –≤—ã—à–ª–∏</div>';
  userInfo.textContent = '–Ω–µ –≤ —Å–∏—Å—Ç–µ–º–µ';
  privateMessageInput.value = '';
  privateMessageInput.disabled = true;
  sendBtn.disabled = true;
  alert('–í—ã –≤—ã—à–ª–∏');
}

/* autologin */
(function autoLogin(){
  const saved = localStorage.getItem('chatUser');
  if(saved){
    currentUser = saved;
    userInfo.textContent = `–í—ã: ${currentUser}`;
    requestNotificationPerm();
    startAppAfterLogin();
  }
})();

/* ---------------- SEARCH USERS (desktop/mobile) ---------------- */
m_searchInput.addEventListener('input', ()=> searchUsers(m_searchInput.value.trim(), mobileSearchResults, 'mobile'));
searchInput.addEventListener('input', ()=> searchUsers(searchInput.value.trim(), searchResults, 'desktop'));

function searchUsers(q, container, mode){
  container.innerHTML = '';
  if(!q) return;
  db.collection('users').get().then(snap=>{
    const found = [];
    snap.forEach(doc => {
      const uname = doc.id;
      if(uname.toLowerCase().includes(q.toLowerCase()) && uname !== currentUser) found.push(uname);
    });
    if(found.length === 0){ container.innerHTML = '<div style="padding:8px;color:var(--muted)">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>'; return; }
    found.forEach(u=>{
      const item = document.createElement('div');
      item.className='chat-item';
      item.innerHTML = `<div style="display:flex;align-items:center;gap:10px"><div class="avatar">${u.charAt(0).toUpperCase()}</div>
                         <div style="min-width:0"><div class="name">${u}</div></div></div>
                         <div><button class="small" data-user="${u}">–ß–∞—Ç</button></div>`;
      item.querySelector('button').addEventListener('click', ()=>{
        startChat(u);
        container.innerHTML = '';
        if(mode === 'desktop') searchInput.value = '';
        else m_searchInput.value = '';
      });
      container.appendChild(item);
    });
  }).catch(err=>console.error(err));
}

/* ----------------- CHATS LIST & UNREAD ----------------- */
function startAppAfterLogin(){
  // enable composer
  privateMessageInput.disabled = false;
  sendBtn.disabled = false;
  // subscribe to chats
  loadChats();
  // subscribe notifications for incoming messages
  subscribeIncomingNotifications();
  // connect typing listener for incoming statuses after login
  subscribeTypingIncoming();
}

/* compute pairKey for chat */
function pairKey(a,b){ const arr = [a,b].slice().sort(); return `${arr[0]}_${arr[1]}`; }

/* load chat list: realtime snapshot of privateMessages, filter client-side by involvement */
function loadChats(){
  if(!currentUser) return;
  if(chatsSnapshotUnsub) chatsSnapshotUnsub();

  chatsSnapshotUnsub = db.collection('privateMessages').orderBy('timestamp','desc')
    .onSnapshot(snapshot=>{
      const lastByUser = {};
      unreadCounts = {};
      snapshot.forEach(doc=>{
        const m = doc.data();
        if(!m) return;
        if(m.from === currentUser || m.to === currentUser){
          const other = m.from === currentUser ? m.to : m.from;
          if(!lastByUser[other]) lastByUser[other] = {...m, id: doc.id};
          // count unread
          if(m.to === currentUser && !m.read) unreadCounts[other] = (unreadCounts[other] || 0) + 1;
        }
      });
      renderChatLists(lastByUser);
      updateMenuBadge();
    }, err => console.error(err));
}

/* render lists on desktop and mobile */
function renderChatLists(lastByUser){
  const users = Object.keys(lastByUser).sort((a,b)=> {
    const ta = lastByUser[a].timestamp ? lastByUser[a].timestamp.toDate().getTime() : 0;
    const tb = lastByUser[b].timestamp ? lastByUser[b].timestamp.toDate().getTime() : 0;
    return tb - ta;
  });

  chatListDesktop.innerHTML = '';
  chatListMobile.innerHTML = '';

  if(users.length === 0){
    chatListDesktop.innerHTML = '<div style="padding:12px;color:var(--muted)">–ù–µ—Ç —á–∞—Ç–æ–≤. –ù–∞–π–¥–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –Ω–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥.</div>';
    chatListMobile.innerHTML = chatListDesktop.innerHTML;
    return;
  }

  users.forEach(u=>{
    const last = lastByUser[u];
    const unread = unreadCounts[u] || 0;

    const el = document.createElement('div');
    el.className = 'chat-item' + (u === selectedUser ? ' active' : '');
    el.innerHTML = `<div class="left"><div class="avatar">${u.charAt(0).toUpperCase()}</div>
                    <div class="meta"><div class="name">${u}</div><div class="last">${escapeHtml(last.message || '')}</div></div></div>
                    <div style="text-align:right"><div style="font-size:12px;color:var(--muted)">${last.timestamp ? formatShortTime(last.timestamp) : ''}</div>
                    ${unread?`<div class="unread">${unread}</div>`:''}</div>`;
    el.addEventListener('click', ()=> { openChat(u); if(window.innerWidth <= 900){ mobilePanel.classList.remove('show'); overlay.classList.remove('show'); overlay.style.display='none'; } });
    const el2 = el.cloneNode(true);
    el2.addEventListener('click', ()=> { openChat(u); mobilePanel.classList.remove('show'); overlay.classList.remove('show'); overlay.style.display='none'; });

    chatListDesktop.appendChild(el);
    chatListMobile.appendChild(el2);
  });
}

function updateMenuBadge(){
  const total = Object.values(unreadCounts).reduce((a,b)=>a+(b||0),0);
  menuBadge.textContent = total > 0 ? `üî¥ ${total}` : '';
}

/* ---------------- OPEN CHAT (subscribe to pairKey) ---------------- */
function openChat(user){
  if(!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
  selectedUser = user;
  chatTitle.textContent = user;
  // mark read for that chat
  markMessagesRead(user);
  // unsubscribe prev
  if(messagesUnsub) messagesUnsub();

  const pk = pairKey(currentUser, user);
  // subscribe to messages with pairKey == pk
  messagesUnsub = db.collection('privateMessages').where('pairKey','==', pk).orderBy('timestamp').onSnapshot(snap=>{
    messagesDiv.innerHTML = '';
    if(snap.empty){
      messagesDiv.innerHTML = '<div style="padding:12px;color:var(--muted)">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —ç—Ç–æ–º –¥–∏–∞–ª–æ–≥–µ.</div>';
      return;
    }
    snap.forEach(doc => {
      const m = doc.data();
      const b = document.createElement('div');
      b.className = 'msg' + (m.from === currentUser ? ' mine' : '');
      b.textContent = m.message;
      const t = document.createElement('div'); t.className = 'time'; t.textContent = formatTime(m.timestamp);
      b.appendChild(t);
      // delete control for own messages
      if(m.from === currentUser){
        const del = document.createElement('span'); del.className = 'del'; del.textContent = 'üóë';
        del.style.marginLeft = '8px';
        del.addEventListener('click', ()=>{
          if(confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) db.collection('privateMessages').doc(doc.id).delete();
        });
        b.appendChild(del);
      }
      messagesDiv.appendChild(b);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }, err => {
    console.error(err);
    messagesDiv.innerHTML = '<div style="padding:12px;color:var(--muted)">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</div>';
  });
}

/* mark messages from user -> currentUser as read */
function markMessagesRead(user){
  db.collection('privateMessages').where('from','==',user).where('to','==',currentUser).where('read','==',false)
    .get().then(snap=>{
      if(snap.empty) return;
      const batch = db.batch();
      snap.forEach(doc=> batch.update(db.collection('privateMessages').doc(doc.id), { read: true }));
      return batch.commit();
    }).catch(e=>console.error(e));
}

/* ---------------- SEND MESSAGE ---------------- */
sendBtn.addEventListener('click', sendMessageHandler);
privateMessageInput.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); sendMessageHandler(); }
  notifyTypingLocal();
});

function sendMessageHandler(){
  if(!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ');
  if(!selectedUser) return alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞');
  const text = privateMessageInput.value.trim();
  if(!text) return;
  const pk = pairKey(currentUser, selectedUser);
  db.collection('privateMessages').add({
    from: currentUser,
    to: selectedUser,
    message: text,
    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    read: false,
    pairKey: pk
  }).then(()=> {
    privateMessageInput.value = '';
    stopTypingLocal();
  }).catch(err=> console.error(err));
}

/* ---------------- TYPING indicator ---------------- */
function notifyTypingLocal(){
  if(!currentUser || !selectedUser) return;
  const id = `${currentUser}_${selectedUser}`;
  typingDocId = id;
  db.collection('typingStatus').doc(id).set({ from: currentUser, to: selectedUser, typing: true, ts: firebase.firestore.FieldValue.serverTimestamp() });
  clearTimeout(localTypingTimer);
  localTypingTimer = setTimeout(()=> stopTypingLocal(), 1200);
}
function stopTypingLocal(){
  if(!typingDocId) return;
  db.collection('typingStatus').doc(typingDocId).set({ from: currentUser, to: selectedUser, typing: false, ts: firebase.firestore.FieldValue.serverTimestamp() });
  typingDocId = null;
  clearTimeout(localTypingTimer);
}

/* listen for typing statuses where to == currentUser */
function subscribeTypingIncoming(){
  if(!currentUser) return;
  db.collection('typingStatus').where('to','==', currentUser).onSnapshot(snap=>{
    let someoneTyping = false;
    snap.forEach(doc=>{
      const d = doc.data();
      // if the typing doc is from the currently selected user and typing==true -> show
      if(selectedUser && d.from === selectedUser && d.typing) someoneTyping = true;
    });
    typingIndicator.style.display = someoneTyping ? 'block' : 'none';
  }, err => console.error(err));
}

/* ---------------- INCOMING NOTIFICATIONS ---------------- */
function requestNotificationPerm(){
  if(!('Notification' in window)) return;
  if(Notification.permission === 'default') Notification.requestPermission();
}
function subscribeIncomingNotifications(){
  if(!currentUser) return;
  // listen for added messages and show notification if to==currentUser and not read
  db.collection('privateMessages').where('to','==', currentUser).orderBy('timestamp','desc').onSnapshot(snap=>{
    snap.docChanges().forEach(change=>{
      if(change.type === 'added'){
        const m = change.doc.data();
        if(m.to === currentUser && !m.read){
          if(Notification.permission === 'granted'){
            new Notification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${m.from}`, { body: m.message, tag: `pm-${m.from}` });
          }
          // update unreadCounts will be updated by loadChats snapshot
        }
      }
    });
  }, err => console.error(err));
}

/* ---------------- UTILITIES ---------------- */
function formatTime(ts){
  if(!ts) return '';
  const d = ts.toDate ? ts.toDate() : new Date(ts);
  return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
}
function formatShortTime(ts){
  if(!ts) return '';
  const d = ts.toDate ? ts.toDate() : new Date(ts);
  return `${d.getDate()}.${(d.getMonth()+1).toString().padStart(2,'0')} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
}
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ---------------- START CHAT from search or direct ---------------- */
function startChat(username){
  if(!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ');
  if(username === currentUser) return alert('–ù–µ–ª—å–∑—è –ø–∏—Å–∞—Ç—å —Å–µ–±–µ');
  selectedUser = username;
  openChat(username);
  // close mobile panel if open
  mobilePanel.classList.remove('show'); overlay.classList.remove('show'); overlay.style.display='none';
}

/* ---------------- ensure mobile search enter ---------------- */
m_searchInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter') searchUsers(m_searchInput.value.trim(), mobileSearchResults, 'mobile'); });

/* ---------------- handle window resize to auto-close panel on desktop ---------------- */
window.addEventListener('resize', ()=>{ if(window.innerWidth > 900){ mobilePanel.classList.remove('show'); overlay.classList.remove('show'); overlay.style.display='none'; } });

/* ---------------- end of script ---------------- */
</script>
</body>
</html>