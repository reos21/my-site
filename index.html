<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–ß–∞—Ç —Å Google-–≤—Ö–æ–¥–æ–º –∏ –¥–∞—Ç–∞–º–∏</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #fafafa;
    }
    #messages {
      border: 1px solid #ccc;
      height: 400px;
      overflow-y: scroll;
      padding: 10px;
      background: #fff;
    }
    .message {
      border-bottom: 1px solid #eee;
      padding: 6px 8px;
      border-radius: 5px;
      margin-bottom: 4px;
    }
    .my-message {
      background: #e7f3ff;
    }
    .time {
      color: #888;
      font-size: 12px;
    }
    .delete-btn {
      background: none;
      border: none;
      color: red;
      cursor: pointer;
      font-size: 14px;
      margin-left: 8px;
    }
    input, button {
      padding: 5px;
      font-size: 16px;
      margin-top: 5px;
    }
    #user-info {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #user-info img {
      width: 32px;
      height: 32px;
      border-radius: 50%;
    }
    .date-separator {
      text-align: center;
      color: #666;
      background: #f0f0f0;
      margin: 10px 0;
      padding: 4px;
      border-radius: 4px;
      font-size: 14px;
    }
  </style>
</head>
<body>

<h2>üí¨ –ß–∞—Ç —Å Google-–≤—Ö–æ–¥–æ–º, –¥–∞—Ç–∞–º–∏ –∏ –ø–æ–º–µ—Ç–∫–æ–π "(–≤—ã)"</h2>

<div id="user-info">
  <button id="login-btn" onclick="signIn()">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
  <button id="logout-btn" onclick="signOut()" style="display:none;">–í—ã–π—Ç–∏</button>
  <span id="user-name"></span>
  <img id="user-pic" src="" alt="" style="display:none;">
</div>

<div id="messages"></div>

<input id="message" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" style="width:70%;" />
<button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyA5meIzTc-zrp3mV2Xg7QQ8Vf_brx58T-g",
    authDomain: "reos21-f0203.firebaseapp.com",
    projectId: "reos21-f0203",
    storageBucket: "reos21-f0203.firebasestorage.app",
    messagingSenderId: "221186151213",
    appId: "1:221186151213:web:7e9f4a842298070d8ff9a4",
    measurementId: "G-61G91NP8DR"
  };

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  const messagesDiv = document.getElementById('messages');
  const userNameEl = document.getElementById('user-name');
  const userPicEl = document.getElementById('user-pic');
  const loginBtn = document.getElementById('login-btn');
  const logoutBtn = document.getElementById('logout-btn');

  let currentUser = null;

  // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Google
  function signIn() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider);
  }

  function signOut() {
    auth.signOut();
  }

  // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ö–æ–¥–∞
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      userNameEl.textContent = user.displayName;
      userPicEl.src = user.photoURL;
      userPicEl.style.display = 'inline';
      loginBtn.style.display = 'none';
      logoutBtn.style.display = 'inline';
    } else {
      currentUser = null;
      userNameEl.textContent = '';
      userPicEl.style.display = 'none';
      loginBtn.style.display = 'inline';
      logoutBtn.style.display = 'none';
    }
  });

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  function sendMessage() {
    if (!currentUser) {
      alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Google!');
      return;
    }

    const message = document.getElementById('message').value.trim();
    if (!message) return;

    db.collection('messages').add({
      name: currentUser.displayName,
      uid: currentUser.uid,
      message: message,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    document.getElementById('message').value = '';
  }

  // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  function deleteMessage(id, uid) {
    if (!currentUser || currentUser.uid !== uid) {
      alert('–í—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è!');
      return;
    }
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
      db.collection('messages').doc(id).delete();
    }
  }

  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
  function formatTime(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate();
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
  }

  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã ("–°–µ–≥–æ–¥–Ω—è", "–í—á–µ—Ä–∞" –∏ —Ç.–ø.)
  function formatDateHeader(date) {
    const now = new Date();
    const d = new Date(date);
    const diffDays = Math.floor((now - d) / (1000 * 60 * 60 * 24));
    if (diffDays === 0) return '–°–µ–≥–æ–¥–Ω—è';
    if (diffDays === 1) return '–í—á–µ—Ä–∞';
    const options = { day: 'numeric', month: 'long', year: 'numeric' };
    return d.toLocaleDateString('ru-RU', options);
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
  db.collection('messages')
    .orderBy('timestamp')
    .onSnapshot(snapshot => {
      messagesDiv.innerHTML = '';
      let lastDate = '';

      snapshot.forEach(doc => {
        const msg = doc.data();
        if (!msg.timestamp) return;
        const time = formatTime(msg.timestamp);
        const dateStr = msg.timestamp.toDate().toDateString();

        // –ù–æ–≤—ã–π –¥–µ–Ω—å ‚Üí –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        if (dateStr !== lastDate) {
          const dateHeader = formatDateHeader(msg.timestamp.toDate());
          messagesDiv.innerHTML += `<div class="date-separator">${dateHeader}</div>`;
          lastDate = dateStr;
        }

        const isMine = currentUser && currentUser.uid === msg.uid;
        const nameLabel = isMine ? `${msg.name} <span style="color:#007bff;">(–≤—ã)</span>` : msg.name;
        const canDelete = isMine;

        const messageHTML = `
          <div class="message ${isMine ? 'my-message' : ''}">
            <b>${nameLabel}</b>: ${msg.message}
            <span class="time">(${time})</span>
            ${canDelete ? `<button class="delete-btn" onclick="deleteMessage('${doc.id}', '${msg.uid}')">üóë</button>` : ''}
          </div>
        `;
        messagesDiv.innerHTML += messageHTML;
      });

      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
</script>

</body>
</html>
