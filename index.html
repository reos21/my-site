<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>–û–±—â–∏–π —á–∞—Ç</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  body { font-family:'Inter',sans-serif; margin:0; display:flex; height:100vh; background:#f0f2f5; transition:0.3s; }
  body.dark-theme { background:#121212; color:#eee; }
  #sidebar { width:220px; background:#fff; border-right:1px solid #ddd; display:flex; flex-direction:column; padding:15px; box-sizing:border-box; transition:0.3s; }
  #sidebar.dark-theme { background:#1e1e1e; color:#eee; border-right:1px solid #333; }
  #sidebar h2 { font-weight:600; margin:0 0 15px 0; }
  #goPrivate, #themeBtn { margin-top:10px; background:#007bff; color:#fff; border:none; cursor:pointer; padding:10px; font-size:16px; border-radius:8px; transition:0.2s; }
  #goPrivate:hover, #themeBtn:hover { background:#0056b3; }

  #chatContainer { flex:1; display:flex; flex-direction:column; padding:15px; box-sizing:border-box; transition:0.3s; }
  #messages { flex:1 0 auto; max-height:70%; overflow-y:auto; padding:10px; background:#fff; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.05); margin-bottom:10px; transition:0.3s; }
  body.dark-theme #messages { background:#1e1e1e; color:#eee; box-shadow:none; }
  .message { padding:8px 12px; margin-bottom:8px; border-radius:12px; position:relative; transition:0.2s; }
  .message:hover { transform:scale(1.01); }
  .my-message { background:#d0ebff; align-self:flex-end; }
  body.dark-theme .my-message { background:#2a2a2a; }
  .time { font-size:12px; color:#888; margin-left:6px; }
  body.dark-theme .time { color:#bbb; }
  .delete-btn { position:absolute; right:8px; top:8px; background:none; border:none; color:red; cursor:pointer; font-size:12px; }
  .date-separator { text-align:center; background:#e0e0e0; padding:3px 8px; margin:10px 0; border-radius:12px; font-size:12px; color:#555; }
  body.dark-theme .date-separator { background:#2a2a2a; color:#aaa; }

  #inputContainer { display:flex; flex-direction:column; gap:5px; }
  input, textarea, #sendBtn { width:100%; box-sizing:border-box; }
  #name, #regPassword { padding:10px; border-radius:8px; border:1px solid #ccc; font-size:16px; }
  body.dark-theme #name, body.dark-theme #regPassword { border:1px solid #555; background:#2a2a2a; color:#eee; }
  #message { padding:12px; border-radius:12px; border:1px solid #ccc; font-size:16px; resize:none; min-height:60px; }
  body.dark-theme #message { border:1px solid #555; background:#2a2a2a; color:#eee; }
  #sendBtn { background:#28a745; color:#fff; border:none; border-radius:12px; padding:10px; font-size:16px; cursor:pointer; transition:0.2s; }
  #sendBtn:hover { background:#1e7e34; }

  #authContainer { display:flex; flex-direction:column; gap:5px; margin-bottom:10px; }
  #authContainer button { background:#007bff; color:#fff; border:none; padding:8px; border-radius:8px; cursor:pointer; transition:0.2s; }
  #authContainer button:hover { background:#0056b3; }

  @media (max-width:700px){
    body { flex-direction:column; }
    #sidebar { width:100%; border-right:none; border-bottom:1px solid #ddd; flex-direction:row; justify-content:space-between; padding:10px; }
    #chatContainer { width:100%; flex:1; padding:10px; }
    #messages { max-height:60%; }
    input, textarea, #sendBtn { font-size:18px; padding:12px; }
    .message { font-size:16px; padding:10px; }
  }
</style>
</head>
<body>

<div id="sidebar">
  <h2>–û–±—â–∏–π —á–∞—Ç</h2>
  <button id="goPrivate" onclick="goPrivate()">üí¨ –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</button>
  <button id="themeBtn" onclick="toggleTheme()">üåô –¢–µ–º–∞</button>
</div>

<div id="chatContainer">
  <div id="authContainer">
    <input id="name" placeholder="–ù–∏–∫">
    <input id="regPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button onclick="registerUser()">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    <button onclick="loginUser()">–í—Ö–æ–¥</button>
    <div id="currentUser"></div>
  </div>

  <div id="messages"></div>
  <div id="inputContainer">
    <textarea id="message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"></textarea>
    <button id="sendBtn" onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<script>
const firebaseConfig = {
  apiKey:"AIzaSyA5meIzTc-zrp3mV2Xg7QQ8Vf_brx58T-g",
  authDomain:"reos21-f0203.firebaseapp.com",
  projectId:"reos21-f0203",
  storageBucket:"reos21-f0203.firebasestorage.app",
  messagingSenderId:"221186151213",
  appId:"1:221186151213:web:7e9f4a842298070d8ff9a4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const messagesDiv = document.getElementById('messages');

let currentUser = null;
let darkMode = false;

// ===== –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –≤—Ö–æ–¥ =====
function registerUser(){
  const name = document.getElementById('name').value.trim();
  const pwd = document.getElementById('regPassword').value.trim();
  if(!name||!pwd) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∏ –ø–∞—Ä–æ–ª—å");
  const hash = CryptoJS.SHA256(pwd).toString();
  db.collection('users').doc(name).get().then(doc=>{
    if(doc.exists) return alert("–ù–∏–∫ –∑–∞–Ω—è—Ç");
    db.collection('users').doc(name).set({passwordHash:hash});
    alert("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞");
  });
}

function loginUser(){
  const name = document.getElementById('name').value.trim();
  const pwd = document.getElementById('regPassword').value.trim();
  if(!name||!pwd) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –∏ –ø–∞—Ä–æ–ª—å");
  const hash = CryptoJS.SHA256(pwd).toString();
  db.collection('users').doc(name).get().then(doc=>{
    if(!doc.exists) return alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω");
    if(doc.data().passwordHash!==hash) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
    currentUser = name;
    localStorage.setItem("chatUser",name);
    document.getElementById('currentUser').textContent = "–í—ã: "+name;
  });
}

// ===== –ê–≤—Ç–æ–ª–æ–≥–∏–Ω =====
window.addEventListener("load",()=>{
  const saved = localStorage.getItem("chatUser");
  if(saved){
    currentUser = saved;
    document.getElementById('currentUser').textContent = "–í—ã: "+saved;
  }
});

// ===== –û–±—â–∏–π —á–∞—Ç =====
function sendMessage(){
  if(!currentUser) return alert("–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç");
  const msg = document.getElementById('message').value.trim();
  if(!msg) return;
  db.collection('commonMessages').add({
    name: currentUser,
    message: msg,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
  document.getElementById('message').value='';
}

function deleteMessage(id,name){
  if(name!==currentUser) return alert("–ú–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è");
  if(confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")) db.collection('commonMessages').doc(id).delete();
}

function formatTime(ts){ if(!ts) return ''; const d=ts.toDate(); return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;}
function formatDateHeader(date){ const now=new Date(); const d=new Date(date); const diff=Math.floor((now-d)/(1000*60*60*24)); if(diff===0)return "–°–µ–≥–æ–¥–Ω—è"; if(diff===1)return "–í—á–µ—Ä–∞"; return d.toLocaleDateString('ru-RU',{day:'numeric',month:'long',year:'numeric'});}

db.collection('commonMessages').orderBy('timestamp').onSnapshot(snapshot=>{
  messagesDiv.innerHTML='';
  let lastDate='';
  snapshot.forEach(doc=>{
    const msg=doc.data();
    if(!msg.timestamp) return;
    const dateStr=msg.timestamp.toDate().toDateString();
    if(dateStr!==lastDate){
      messagesDiv.innerHTML+=`<div class="date-separator">${formatDateHeader(msg.timestamp.toDate())}</div>`;
      lastDate=dateStr;
    }
    const isMine=msg.name===currentUser;
    messagesDiv.innerHTML+=`<div class="message ${isMine?'my-message':''}">
      <b>${msg.name}</b>: ${msg.message} <span class="time">(${formatTime(msg.timestamp)})</span>
      ${isMine?`<button class="delete-btn" onclick="deleteMessage('${doc.id}','${msg.name}')">üóë</button>`:''}
    </div>`;
  });
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
});

// ===== –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è =====
function goPrivate(){ window.location.href="private.html"; }

// ===== –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ =====
function toggleTheme(){
  darkMode=!darkMode;
  if(darkMode) document.body.classList.add("dark-theme");
  else document.body.classList.remove("dark-theme");
}
</script>
</body>
</html>