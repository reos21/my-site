<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Ð¼Ð°Ñ‚Ð²ÐµÐ¹ÐºÐ° Ñ‡Ð°Ñ‚</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #fafafa;
    }
    #messages {
      border: 1px solid #ccc;
      height: 400px;
      overflow-y: scroll;
      padding: 10px;
      background: #fff;
    }
    .message {
      border-bottom: 1px solid #eee;
      padding: 6px 8px;
      border-radius: 5px;
      margin-bottom: 4px;
    }
    .my-message {
      background: #e7f3ff;
    }
    .time {
      color: #888;
      font-size: 12px;
    }
    .delete-btn {
      background: none;
      border: none;
      color: red;
      cursor: pointer;
      font-size: 14px;
      margin-left: 8px;
    }
    input, button {
      padding: 5px;
      font-size: 16px;
      margin-top: 5px;
    }
    #user-section {
      margin-bottom: 10px;
    }
    .date-separator {
      text-align: center;
      color: #666;
      background: #f0f0f0;
      margin: 10px 0;
      padding: 4px;
      border-radius: 4px;
      font-size: 14px;
    }
  </style>
</head>
<body>

<h2>Ð¾Ð±Ñ‰Ð°Ðº</h2>

<div id="user-section">
  <input id="name" placeholder="Ð’Ð°ÑˆÐµ Ð¸Ð¼Ñ" />
</div>

<div id="messages"></div>

<input id="message" placeholder="Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ" style="width:70%;" />
<button onclick="sendMessage()">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ</button>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  // ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyA5meIzTc-zrp3mV2Xg7QQ8Vf_brx58T-g",
    authDomain: "reos21-f0203.firebaseapp.com",
    projectId: "reos21-f0203",
    storageBucket: "reos21-f0203.firebasestorage.app",
    messagingSenderId: "221186151213",
    appId: "1:221186151213:web:7e9f4a842298070d8ff9a4",
    measurementId: "G-61G91NP8DR"
  };

  // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const messagesDiv = document.getElementById('messages');

  // Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ID Ð´Ð»Ñ "Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ"
  const localUserId = localStorage.getItem('chatUserId') || Date.now().toString(36) + Math.random().toString(36).substr(2);
  localStorage.setItem('chatUserId', localUserId);

  // ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
  function sendMessage() {
    const name = document.getElementById('name').value.trim() || 'Ð“Ð¾ÑÑ‚ÑŒ';
    const message = document.getElementById('message').value.trim();
    if (!message) return;

    db.collection('messages').add({
      name: name,
      uid: localUserId,
      message: message,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    document.getElementById('message').value = '';
  }

  // Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
  function deleteMessage(id, uid) {
    if (uid !== localUserId) {
      alert('Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ ÑƒÐ´Ð°Ð»ÑÑ‚ÑŒ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ²Ð¾Ð¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ!');
      return;
    }
    if (confirm('Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÑ‚Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ?')) {
      db.collection('messages').doc(id).delete();
    }
  }

  // Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
  function formatTime(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate();
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
  }

  // Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð°Ñ‚Ñ‹
  function formatDateHeader(date) {
    const now = new Date();
    const d = new Date(date);
    const diffDays = Math.floor((now - d) / (1000 * 60 * 60 * 24));
    if (diffDays === 0) return 'Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ';
    if (diffDays === 1) return 'Ð’Ñ‡ÐµÑ€Ð°';
    const options = { day: 'numeric', month: 'long', year: 'numeric' };
    return d.toLocaleDateString('ru-RU', options);
  }

  // ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
  db.collection('messages')
    .orderBy('timestamp')
    .onSnapshot(snapshot => {
      messagesDiv.innerHTML = '';
      let lastDate = '';

      snapshot.forEach(doc => {
        const msg = doc.data();
        if (!msg.timestamp) return;

        const time = formatTime(msg.timestamp);
        const dateStr = msg.timestamp.toDate().toDateString();

        if (dateStr !== lastDate) {
          const dateHeader = formatDateHeader(msg.timestamp.toDate());
          messagesDiv.innerHTML += `<div class="date-separator">${dateHeader}</div>`;
          lastDate = dateStr;
        }

        const isMine = msg.uid === localUserId;
        const nameLabel = isMine ? `${msg.name} <span style="color:#007bff;">(Ð²Ñ‹)</span>` : msg.name;
        const canDelete = isMine;

        const messageHTML = `
          <div class="message ${isMine ? 'my-message' : ''}">
            <b>${nameLabel}</b>: ${msg.message}
            <span class="time">(${time})</span>
            ${canDelete ? `<button class="delete-btn" onclick="deleteMessage('${doc.id}', '${msg.uid}')">ðŸ—‘</button>` : ''}
          </div>
        `;
        messagesDiv.innerHTML += messageHTML;
      });

      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
</script>

</body>
</html>
