<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>–ü—Ä–æ—Å—Ç–æ–π —á–∞—Ç —Å –∏–º–µ–Ω–∞–º–∏</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #fafafa;
    }
    #messages {
      border: 1px solid #ccc;
      height: 400px;
      overflow-y: scroll;
      padding: 10px;
      background: #fff;
    }
    .message {
      border-bottom: 1px solid #eee;
      padding: 6px 8px;
      border-radius: 5px;
      margin-bottom: 4px;
    }
    .my-message {
      background: #e7f3ff;
    }
    .time {
      color: #888;
      font-size: 12px;
    }
    .delete-btn {
      background: none;
      border: none;
      color: red;
      cursor: pointer;
      font-size: 14px;
      margin-left: 8px;
    }
    input, button {
      padding: 5px;
      font-size: 16px;
      margin-top: 5px;
    }
    #user-section {
      margin-bottom: 10px;
    }
    .date-separator {
      text-align: center;
      color: #666;
      background: #f0f0f0;
      margin: 10px 0;
      padding: 4px;
      border-radius: 4px;
      font-size: 14px;
    }
  </style>
</head>
<body>

<h2>üí¨ –ü—Ä–æ—Å—Ç–æ–π —á–∞—Ç</h2>

<div id="user-section">
  <input id="name" placeholder="–í–∞—à–µ –∏–º—è" />
</div>

<div id="messages"></div>

<input id="message" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" style="width:70%;" />
<button onclick="sendMessage()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyA5meIzTc-zrp3mV2Xg7QQ8Vf_brx58T-g",
    authDomain: "reos21-f0203.firebaseapp.com",
    projectId: "reos21-f0203",
    storageBucket: "reos21-f0203.firebasestorage.app",
    messagingSenderId: "221186151213",
    appId: "1:221186151213:web:7e9f4a842298070d8ff9a4",
    measurementId: "G-61G91NP8DR"
  };

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const messagesDiv = document.getElementById('messages');

  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è "—Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
  const localUserId = localStorage.getItem('chatUserId') || Date.now().toString(36) + Math.random().toString(36).substr(2);
  localStorage.setItem('chatUserId', localUserId);

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
  function sendMessage() {
    const name = document.getElementById('name').value.trim() || '–ì–æ—Å—Ç—å';
    const message = document.getElementById('message').value.trim();
    if (!message) return;

    db.collection('messages').add({
      name: name,
      uid: localUserId,
      message: message,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    document.getElementById('message').value = '';
  }

  // –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  function deleteMessage(id, uid) {
    if (uid !== localUserId) {
      alert('–í—ã –º–æ–∂–µ—Ç–µ —É–¥–∞–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è!');
      return;
    }
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
      db.collection('messages').doc(id).delete();
    }
  }

  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
  function formatTime(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate();
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
  }

  // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
  function formatDateHeader(date) {
    const now = new Date();
    const d = new Date(date);
    const diffDays = Math.floor((now - d) / (1000 * 60 * 60 * 24));
    if (diffDays === 0) return '–°–µ–≥–æ–¥–Ω—è';
    if (diffDays === 1) return '–í—á–µ—Ä–∞';
    const options = { day: 'numeric', month: 'long', year: 'numeric' };
    return d.toLocaleDateString('ru-RU', options);
  }

  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
  db.collection('messages')
    .orderBy('timestamp')
    .onSnapshot(snapshot => {
      messagesDiv.innerHTML = '';
      let lastDate = '';

      snapshot.forEach(doc => {
        const msg = doc.data();
        if (!msg.timestamp) return;

        const time = formatTime
        .timestamp);
        const dateStr = msg.timestamp.toDate().toDateString();

        if (dateStr !== lastDate) {
          const dateHeader = formatDateHeader(msg.timestamp.toDate());
          messagesDiv.innerHTML += `<div class="date-separator">${dateHeader}</div>`;
          lastDate = dateStr;
        }

        const isMine = msg.uid === localUserId;
        const nameLabel = isMine ? `${msg.name} <span style="color:#007bff;">(–≤—ã)</span>` : msg.name;
        const canDelete = isMine;

        const messageHTML = `
          <div class="message ${isMine ? 'my-message' : ''}">
            <b>${nameLabel}</b>: ${msg.message}
            <span class="time">(${time})</span>
            ${canDelete ? `<button class="delete-btn" onclick="deleteMessage('${doc.id}', '${msg.uid}')">üóë</button>` : ''}
          </div>
        `;
        messagesDiv.innerHTML += messageHTML;
      });

      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
</script>

</body>
</html>(msg
